<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Class Transaction</title>
<link rel="stylesheet" href="../boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.79.1">
<link rel="home" href="../index.html" title="Chapter 1. STLdb 1.0">
<link rel="up" href="../stldb_reference.html#header..Users.bobw.workspaces.STLdb.stldb_lib.stldb.transaction_h" title="Header &lt;/Users/bobw/workspaces/STLdb/stldb_lib/stldb/transaction.h&gt;">
<link rel="prev" href="exclusive_transaction.html" title="Class exclusive_transaction">
<link rel="next" href="transactional_op_list.html" title="Class transactional_op_list">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr><td valign="top"><img alt="STLdb" width="253" height="108" src="../images/stldb_logo.png"></td></tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="exclusive_transaction.html"><img src="../images/prev.png" alt="Prev"></a><a accesskey="u" href="../stldb_reference.html#header..Users.bobw.workspaces.STLdb.stldb_lib.stldb.transaction_h"><img src="../images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../images/home.png" alt="Home"></a><a accesskey="n" href="transactional_op_list.html"><img src="../images/next.png" alt="Next"></a>
</div>
<div class="refentry">
<a name="stldb.Transaction"></a><div class="titlepage"></div>
<div class="refnamediv">
<h2><span class="refentrytitle">Class Transaction</span></h2>
<p>stldb::Transaction — <a class="link" href="Transaction.html" title="Class Transaction">Transaction</a> represents the details of an in-progress transaction, including modifications which are in progress. A transaction is created by the <a class="link" href="Database.html" title="Class template Database">Database</a> class, acting as a factory. A <a class="link" href="Transaction.html" title="Class Transaction">Transaction</a> is resolved by passing it to either the commit or rollback method of the <a class="link" href="Database.html" title="Class template Database">Database</a>. <br>
 This was done to prevent the need for the <a class="link" href="Transaction.html" title="Class Transaction">Transaction</a> type to itself be a template class. </p>
</div>
<h2 xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" class="refsynopsisdiv-title">Synopsis</h2>
<div xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" class="refsynopsisdiv"><pre class="synopsis"><span class="comment">// In header: &lt;<a class="link" href="../stldb_reference.html#header..Users.bobw.workspaces.STLdb.stldb_lib.stldb.transaction_h" title="Header &lt;/Users/bobw/workspaces/STLdb/stldb_lib/stldb/transaction.h&gt;">/Users/bobw/workspaces/STLdb/stldb_lib/stldb/transaction.h</a>&gt;

</span>
<span class="keyword">class</span> <a class="link" href="Transaction.html" title="Class Transaction">Transaction</a> <span class="special">{</span>
<span class="keyword">public</span><span class="special">:</span>
  <span class="comment">// <a class="link" href="Transaction.html#stldb.Transactionconstruct-copy-destruct">construct/copy/destruct</a></span>
  <a class="link" href="Transaction.html#idp105544917386000-bb"><span class="identifier">Transaction</span></a><span class="special">(</span><span class="special">)</span><span class="special">;</span>
  <a class="link" href="Transaction.html#idp105544917389968-bb"><span class="identifier">Transaction</span></a><span class="special">(</span><span class="keyword">const</span> <a class="link" href="Transaction.html" title="Class Transaction">Transaction</a> <span class="special">&amp;</span><span class="special">)</span><span class="special">;</span>
  <a class="link" href="Transaction.html" title="Class Transaction">Transaction</a> <span class="special">&amp;</span> <a class="link" href="Transaction.html#idp105544917391120-bb"><span class="keyword">operator</span><span class="special">=</span></a><span class="special">(</span><span class="keyword">const</span> <a class="link" href="Transaction.html" title="Class Transaction">Transaction</a> <span class="special">&amp;</span><span class="special">)</span><span class="special">;</span>
  <a class="link" href="Transaction.html#idp105544917385232-bb"><span class="special">~</span><span class="identifier">Transaction</span></a><span class="special">(</span><span class="special">)</span><span class="special">;</span>

  <span class="comment">// <a class="link" href="Transaction.html#idp105544917430288-bb">public member functions</a></span>
  <span class="keyword">template</span><span class="special">&lt;</span><span class="keyword">typename</span> ManagedRegionType<span class="special">,</span> <span class="keyword">typename</span> void_alloc_t<span class="special">,</span> 
           <span class="keyword">typename</span> mutex_t<span class="special">&gt;</span> 
    <span class="keyword">void</span> <a class="link" href="Transaction.html#idp105544917430672-bb"><span class="identifier">commit</span></a><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">map</span><span class="special">&lt;</span> <span class="keyword">void</span> <span class="special">*</span><span class="special">,</span> <a class="link" href="container_proxy_base.html" title="Class template container_proxy_base">container_proxy_base</a><span class="special">&lt;</span> <span class="identifier">ManagedRegionType</span> <span class="special">&gt;</span> <span class="special">*</span> <span class="special">&gt;</span> <span class="special">&amp;</span><span class="special">,</span> 
                <a class="link" href="Logger.html" title="Class template Logger">Logger</a><span class="special">&lt;</span> <span class="identifier">void_alloc_t</span><span class="special">,</span> <span class="identifier">mutex_t</span> <span class="special">&gt;</span> <span class="special">&amp;</span><span class="special">,</span> <span class="keyword">bool</span><span class="special">,</span> 
                <a class="link" href="commit_buffer_t.html" title="Class template commit_buffer_t">commit_buffer_t</a><span class="special">&lt;</span> <span class="identifier">void_alloc_t</span> <span class="special">&gt;</span> <span class="special">*</span><span class="special">)</span><span class="special">;</span>
  <span class="keyword">template</span><span class="special">&lt;</span><span class="keyword">typename</span> ManagedRegionType<span class="special">&gt;</span> 
    <span class="keyword">void</span> <a class="link" href="Transaction.html#idp105544917371920-bb"><span class="identifier">rollback</span></a><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">map</span><span class="special">&lt;</span> <span class="keyword">void</span> <span class="special">*</span><span class="special">,</span> <a class="link" href="container_proxy_base.html" title="Class template container_proxy_base">container_proxy_base</a><span class="special">&lt;</span> <span class="identifier">ManagedRegionType</span> <span class="special">&gt;</span> <span class="special">*</span> <span class="special">&gt;</span> <span class="special">&amp;</span><span class="special">)</span><span class="special">;</span>
  <span class="identifier">transaction_id_t</span> <a class="link" href="Transaction.html#idp105544917375504-bb"><span class="identifier">getLockId</span></a><span class="special">(</span><span class="special">)</span> <span class="keyword">const</span><span class="special">;</span>
  <span class="identifier">transaction_id_t</span> <a class="link" href="Transaction.html#idp105544917376528-bb"><span class="identifier">getLSN</span></a><span class="special">(</span><span class="special">)</span> <span class="keyword">const</span><span class="special">;</span>
  <span class="keyword">template</span><span class="special">&lt;</span><span class="keyword">typename</span> container_t<span class="special">&gt;</span> 
    <span class="keyword">void</span> <a class="link" href="Transaction.html#idp105544917377680-bb"><span class="identifier">insert_work_in_progress</span></a><span class="special">(</span><span class="identifier">container_t</span> <span class="special">*</span><span class="special">,</span> <a class="link" href="TransactionalOperation.html" title="Class TransactionalOperation">TransactionalOperation</a> <span class="special">*</span><span class="special">)</span><span class="special">;</span>
  <a class="link" href="transactional_op_list.html" title="Class transactional_op_list">transactional_op_list</a> <span class="special">&amp;</span> <a class="link" href="Transaction.html#idp105544917380240-bb"><span class="identifier">get_work_in_progress</span></a><span class="special">(</span><span class="special">)</span><span class="special">;</span>
  <span class="keyword">template</span><span class="special">&lt;</span><span class="keyword">typename</span> T<span class="special">,</span> <span class="keyword">typename</span> container_t<span class="special">&gt;</span> 
    <span class="identifier">T</span> <span class="special">*</span> <a class="link" href="Transaction.html#idp105544917382288-bb"><span class="identifier">getContainerSpecificData</span></a><span class="special">(</span><span class="identifier">container_t</span> <span class="special">*</span><span class="special">)</span><span class="special">;</span>

  <span class="comment">// <a class="link" href="Transaction.html#idp105544917386256-bb">private member functions</a></span>
  <span class="keyword">virtual</span> <span class="keyword">void</span> 
  <a class="link" href="Transaction.html#idp105544917386640-bb"><span class="identifier">lock_database</span></a><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">interprocess</span><span class="special">::</span><span class="identifier">interprocess_upgradable_mutex</span> <span class="special">&amp;</span><span class="special">)</span><span class="special">;</span>
  <span class="keyword">virtual</span> <span class="keyword">void</span> <a class="link" href="Transaction.html#idp105544917387920-bb"><span class="identifier">unlock_database</span></a><span class="special">(</span><span class="special">)</span><span class="special">;</span>
  <span class="keyword">void</span> <a class="link" href="Transaction.html#idp105544917388688-bb"><span class="identifier">clear</span></a><span class="special">(</span><span class="keyword">void</span><span class="special">)</span><span class="special">;</span>
<span class="special">}</span><span class="special">;</span></pre></div>
<div class="refsect1">
<a name="idp105545220608144"></a><h2>Description</h2>
<div class="refsect2">
<a name="idp105545220608528"></a><h3>
<a name="stldb.Transactionconstruct-copy-destruct"></a><code class="computeroutput">Transaction</code> 
        public
       construct/copy/destruct</h3>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><pre class="literallayout"><a name="idp105544917386000-bb"></a><span class="identifier">Transaction</span><span class="special">(</span><span class="special">)</span><span class="special">;</span></pre></li>
<li class="listitem"><pre class="literallayout"><a name="idp105544917389968-bb"></a><span class="identifier">Transaction</span><span class="special">(</span><span class="keyword">const</span> <a class="link" href="Transaction.html" title="Class Transaction">Transaction</a> <span class="special">&amp;</span> t<span class="special">)</span><span class="special">;</span></pre></li>
<li class="listitem"><pre class="literallayout"><a class="link" href="Transaction.html" title="Class Transaction">Transaction</a> <span class="special">&amp;</span> <a name="idp105544917391120-bb"></a><span class="keyword">operator</span><span class="special">=</span><span class="special">(</span><span class="keyword">const</span> <a class="link" href="Transaction.html" title="Class Transaction">Transaction</a> <span class="special">&amp;</span> t<span class="special">)</span><span class="special">;</span></pre></li>
<li class="listitem"><pre class="literallayout"><a name="idp105544917385232-bb"></a><span class="special">~</span><span class="identifier">Transaction</span><span class="special">(</span><span class="special">)</span><span class="special">;</span></pre></li>
</ol></div>
</div>
<div class="refsect2">
<a name="idp105545220624528"></a><h3>
<a name="idp105544917430288-bb"></a><code class="computeroutput">Transaction</code> public member functions</h3>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem">
<pre class="literallayout"><span class="keyword">template</span><span class="special">&lt;</span><span class="keyword">typename</span> ManagedRegionType<span class="special">,</span> <span class="keyword">typename</span> void_alloc_t<span class="special">,</span> <span class="keyword">typename</span> mutex_t<span class="special">&gt;</span> 
  <span class="keyword">void</span> <a name="idp105544917430672-bb"></a><span class="identifier">commit</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">map</span><span class="special">&lt;</span> <span class="keyword">void</span> <span class="special">*</span><span class="special">,</span> <a class="link" href="container_proxy_base.html" title="Class template container_proxy_base">container_proxy_base</a><span class="special">&lt;</span> <span class="identifier">ManagedRegionType</span> <span class="special">&gt;</span> <span class="special">*</span> <span class="special">&gt;</span> <span class="special">&amp;</span> proxies<span class="special">,</span> 
              <a class="link" href="Logger.html" title="Class template Logger">Logger</a><span class="special">&lt;</span> <span class="identifier">void_alloc_t</span><span class="special">,</span> <span class="identifier">mutex_t</span> <span class="special">&gt;</span> <span class="special">&amp;</span> logger<span class="special">,</span> <span class="keyword">bool</span> diskless<span class="special">,</span> 
              <a class="link" href="commit_buffer_t.html" title="Class template commit_buffer_t">commit_buffer_t</a><span class="special">&lt;</span> <span class="identifier">void_alloc_t</span> <span class="special">&gt;</span> <span class="special">*</span> buffer<span class="special">)</span><span class="special">;</span></pre>
<p>Most of the work associated with commit is actually done by the polymorphic <code class="computeroutput"><a class="link" href="TransactionalOperation.html" title="Class TransactionalOperation">TransactionalOperation</a></code> objects which accumulate in the <code class="computeroutput"><a class="link" href="Transaction.html" title="Class Transaction">Transaction</a></code>. Commit must lock each container in turn and hold all locks until all operations are done. (This is required to meet the ACI part of ACID.) To ensure that multiple commits don't deadlock, they all must consistently lock containers in the same order. The ordering of _outstandingChanges assures this. </p>
<p>Release all container locks. It is now acceptable for other threads to begin doing work on top of our committed data because they can't jump ahead of us in the logging queue.</p>
</li>
<li class="listitem">
<pre class="literallayout"><span class="keyword">template</span><span class="special">&lt;</span><span class="keyword">typename</span> ManagedRegionType<span class="special">&gt;</span> 
  <span class="keyword">void</span> <a name="idp105544917371920-bb"></a><span class="identifier">rollback</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">map</span><span class="special">&lt;</span> <span class="keyword">void</span> <span class="special">*</span><span class="special">,</span> <a class="link" href="container_proxy_base.html" title="Class template container_proxy_base">container_proxy_base</a><span class="special">&lt;</span> <span class="identifier">ManagedRegionType</span> <span class="special">&gt;</span> <span class="special">*</span> <span class="special">&gt;</span> <span class="special">&amp;</span> proxies<span class="special">)</span><span class="special">;</span></pre>
<p>Most of the work associated with rollback is likewise done by the polymorphic <code class="computeroutput"><a class="link" href="TransactionalOperation.html" title="Class TransactionalOperation">TransactionalOperation</a></code> objects which accumulate in the <code class="computeroutput"><a class="link" href="Transaction.html" title="Class Transaction">Transaction</a></code>. </p>
</li>
<li class="listitem">
<pre class="literallayout"><span class="identifier">transaction_id_t</span> <a name="idp105544917375504-bb"></a><span class="identifier">getLockId</span><span class="special">(</span><span class="special">)</span> <span class="keyword">const</span><span class="special">;</span></pre>Return the lock_id of this transaction. </li>
<li class="listitem">
<pre class="literallayout"><span class="identifier">transaction_id_t</span> <a name="idp105544917376528-bb"></a><span class="identifier">getLSN</span><span class="special">(</span><span class="special">)</span> <span class="keyword">const</span><span class="special">;</span></pre>
<p>Return the lsn assigned to this transaction. LSN assignment occurs during commit processing. </p>
</li>
<li class="listitem"><pre class="literallayout"><span class="keyword">template</span><span class="special">&lt;</span><span class="keyword">typename</span> container_t<span class="special">&gt;</span> 
  <span class="keyword">void</span> <a name="idp105544917377680-bb"></a><span class="identifier">insert_work_in_progress</span><span class="special">(</span><span class="identifier">container_t</span> <span class="special">*</span> container<span class="special">,</span> 
                               <a class="link" href="TransactionalOperation.html" title="Class TransactionalOperation">TransactionalOperation</a> <span class="special">*</span> op<span class="special">)</span><span class="special">;</span></pre></li>
<li class="listitem">
<pre class="literallayout"><a class="link" href="transactional_op_list.html" title="Class transactional_op_list">transactional_op_list</a> <span class="special">&amp;</span> <a name="idp105544917380240-bb"></a><span class="identifier">get_work_in_progress</span><span class="special">(</span><span class="special">)</span><span class="special">;</span></pre>
<p>Returns the <code class="computeroutput"><a class="link" href="transactional_op_list.html" title="Class transactional_op_list">transactional_op_list</a></code> of outstanding operations. <br>
 There are some operations like swap() or clear() which might need to adjust information on previous operations against the same container as part of their implementation. </p>
</li>
<li class="listitem">
<pre class="literallayout"><span class="keyword">template</span><span class="special">&lt;</span><span class="keyword">typename</span> T<span class="special">,</span> <span class="keyword">typename</span> container_t<span class="special">&gt;</span> 
  <span class="identifier">T</span> <span class="special">*</span> <a name="idp105544917382288-bb"></a><span class="identifier">getContainerSpecificData</span><span class="special">(</span><span class="identifier">container_t</span> <span class="special">*</span> c<span class="special">)</span><span class="special">;</span></pre>
<p>Return the pending changes container (some subclass of PendingChangeSet) for the container ref passed. If none exists, and create_flag = true, create one.</p>
<p>Return the pending changes container (some subclass of PendingChangeSet) for the container ref passed. If none exists, and create_flag = true, create one. Note: Although this returns T*, the transaction object retains ownership of the object. When _pendingChanges is destroyed (by the transaction destructor), the boost::any values within that map are also destroyed which in turn destroys all container specific data held by the transaction. </p>
</li>
</ol></div>
</div>
<div class="refsect2">
<a name="idp105545220558224"></a><h3>
<a name="idp105544917386256-bb"></a><code class="computeroutput">Transaction</code> private member functions</h3>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem"><pre class="literallayout"><span class="keyword">virtual</span> <span class="keyword">void</span> 
<a name="idp105544917386640-bb"></a><span class="identifier">lock_database</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">interprocess</span><span class="special">::</span><span class="identifier">interprocess_upgradable_mutex</span> <span class="special">&amp;</span> mutex<span class="special">)</span><span class="special">;</span></pre></li>
<li class="listitem"><pre class="literallayout"><span class="keyword">virtual</span> <span class="keyword">void</span> <a name="idp105544917387920-bb"></a><span class="identifier">unlock_database</span><span class="special">(</span><span class="special">)</span><span class="special">;</span></pre></li>
<li class="listitem"><pre class="literallayout"><span class="keyword">void</span> <a name="idp105544917388688-bb"></a><span class="identifier">clear</span><span class="special">(</span><span class="keyword">void</span><span class="special">)</span><span class="special">;</span></pre></li>
</ol></div>
</div>
</div>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright © 2009 Bob Walters<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="exclusive_transaction.html"><img src="../images/prev.png" alt="Prev"></a><a accesskey="u" href="../stldb_reference.html#header..Users.bobw.workspaces.STLdb.stldb_lib.stldb.transaction_h"><img src="../images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../images/home.png" alt="Home"></a><a accesskey="n" href="transactional_op_list.html"><img src="../images/next.png" alt="Next"></a>
</div>
</body>
</html>
